generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id           String        @id @default(cuid())
  telegramId   String?
  nome         String
  idade        Int
  matricula    String        @unique
  curso        String
  periodo      String
  createdAt    DateTime      @default(now())
  appointments Appointment[] @relation("StudentAppointments")
  screenings   Screening[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         String   @default("PROFESSIONAL")
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Screening {
  id              String          @id @default(cuid())
  studentId       String
  phq9Respostas   Int[]
  phq9Score       Int
  gad7Respostas   Int[]
  gad7Score       Int
  disponibilidade String
  observacao      String?
  relatorio       String
  riskPHQ9        RiskLevel
  riskGAD7        RiskLevel
  createdAt       DateTime        @default(now())
  status          ScreeningStatus @default(NEW)
  appointment     Appointment?
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Appointment {
  id           String            @id @default(cuid())
  screeningId  String?           @unique
  studentId    String?
  caseId       String?
  startsAt     DateTime
  endsAt       DateTime
  durationMin  Int
  channel      String
  professional String
  status       AppointmentStatus @default(PENDING)
  note         String?
  screening    Screening?        @relation(fields: [screeningId], references: [id])
  student      Student?          @relation("StudentAppointments", fields: [studentId], references: [id])
  sessionNote  SessionNote?

  @@index([professional, startsAt, endsAt])
  @@index([studentId])
}

model SessionNote {
  id            String      @id @default(cuid())
  appointmentId String      @unique
  studentId     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  before        String?
  complaint     String?
  summary       String?
  observation   String?
  evolution     String?
  sharedField   String?
  fixedNote     String?
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

enum RiskLevel {
  MINIMO
  LEVE
  MODERADO
  MODERADAMENTE_GRAVE
  GRAVE
}

enum ScreeningStatus {
  NEW
  REVIEWED
  SCHEDULED
  CONVERTED
  ARCHIVED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  DONE
  NO_SHOW
  CANCELLED
}
